1. Серверы и их роли:

1. OpenVPN Server (89.169.159.157):
   - Роль: Обеспечивает VPN-доступ для пользователей.
   - Установленные сервисы: openvpn, node-exporter, openvpn-exporter.
   - Пользователи подключаются через VPN-клиент (например, OpenVPN Client) для доступа к внутренним ресурсам.

2. CA Server (89.169.135.4):
   - Роль: Центр сертификации, управляет SSL-сертификатами с использованием easy-rsa.
   - Установленные сервисы: node-exporter, ssl-exporter, easy-rsa.
   - Пользователи (администраторы) подключаются для управления сертификатами.
   
3. Prometheus Server (89.169.154.113):
   - Роль: Сбор и мониторинг метрик с других серверов.
   - Установленные сервисы: prometheus, alertmanager, node-exporter.
   - Веб-интерфейс Prometheus доступен по домену raif.hopto.org и защищён SSL-сертификатом, созданным с помощью certbot.
   - Пользователи (администраторы) получают доступ к веб-интерфейсу Prometheus и Alertmanager для мониторинга и управления уведомлениями.

4. Backup Server (130.193.54.71):
   - Роль: Хранение резервных копий данных.
   - Установленные сервисы: node-exporter, restic (инструмент для бэкапов), cloud backup (интеграция с облачным хранилищем).
   - Пользователи (администраторы) подключаются для управления бэкапами.


2. Взаимодействие между серверами:

2.1. Сбор метрик:
- Prometheus собирает метрики с каждого сервера через node-exporter, openvpn-exporter и ssl-exporter.
  - OpenVPN Server:
    - Адрес: 89.169.159.157
    - Порты:
      - node-exporter: 9100 (по умолчанию)
      - openvpn-exporter: 9176 (по умолчанию)
  - CA Server:
    - Адрес: 89.169.135.4
    - Порты:
      - node-exporter: 9100
      - ssl-exporter: 9117 (по умолчанию)
  - Prometheus Server:
    - Адрес: 89.169.154.113
    - Порты:
      - node-exporter: 9100
  - Backup Server:
    - Адрес: 130.193.54.71
    - Порты:
      - node-exporter: 9100

2.2. Уведомления:
- Alertmanager на Prometheus Server отправляет уведомления на почту администраторов в случае возникновения проблем.
  - Адрес: 89.169.154.113
  - Порт: 9093 (по умолчанию для Alertmanager)

2.3. Бэкапирование:
- Backup Server использует инструмент restic для создания резервных копий данных с других серверов через SSH.
  - Адреса источников:
    - OpenVPN Server: 89.169.159.157
    - CA Server: 89.169.135.4
    - Prometheus Server: 89.169.154.113
  - Порт SSH: 22

2.4. Доступ пользователей:
- Пользователи подключаются к серверам через SSH (порт 22) для администрирования.
- Пользователи VPN подключаются к OpenVPN Server через порт 1194 (по умолчанию для OpenVPN).
- Веб-интерфейс Prometheus доступен по домену raif.hopto.org через HTTPS (порт 443).


3. Передаваемая информация:
1. Метрики:
   - Данные о состоянии серверов (CPU, RAM, дисковое пространство и т.д.) собираются node-exporter.
   - Данные о состоянии OpenVPN (количество подключённых пользователей, статус сервиса) собираются openvpn-exporter.
   - Данные о состоянии SSL-сертификатов (сроки действия, ошибки) собираются ssl-exporter.

2. Уведомления:
   - Alertmanager отправляет уведомления на почту администраторов в формате JSON или plain text.

3. Резервные копии:
   - Данные для бэкапирования передаются через SSH в зашифрованном виде с использованием restic.

4. Веб-интерфейс Prometheus:
   - Доступен по домену raif.hopto.org через HTTPS (порт 443).
   - Защищён SSL-сертификатом, созданным с помощью certbot.


4. Схема потоков данных:


Пользователи VPN
       |
       v
[OpenVPN Server] (89.169.159.157:1194)
       | (метрики)
       v
[Prometheus Server] (89.169.154.113:9090)
       | (уведомления)
       v
[Alertmanager] (89.169.154.113:9093) -> Email
       |
       v
[Backup Server] (130.193.54.71:22) <- SSH (restic)
       ^
       | (метрики)
[CA Server] (89.169.135.4:9100, 9117)



5. Веб-интерфейс Prometheus:
- Домен: raif.hopto.org
- Протокол: HTTPS
- Порт: 443
- SSL-сертификат: Создан с помощью certbot.


6. Зоны доступности:
- Backup Server: ru-central1-b
- Остальные серверы: ru-central1-a


7. Автоматизация и развёртывание:
- Для развёртывания серверов используются скрипты и deb-пакеты с конфигами, доступные в репозитории GitHub: (https://github.com/RaifSpace/raif-devops).
- Скрипты для автоматизации:
  - CA Server: install-ca.sh
  - OpenVPN Server: install-vpnsrv.sh
  - Prometheus Server: install-promsrv.sh
  - Backup Server: backup.sh
Скрипт для изменения конфигурации сетевого экрана:
  - iptables.sh
  Пример использования: ./iptables.sh <сетевой_интерфейс> <протокол> <порт> (скрипту должно быть передано три аргумента, например: ./iptables.sh eth0 udp 1194)
Скрипт для создания клиентской конфигурации:
  - make-config.sh
  Пример использования: ./make-config.sh <имя_клиента> (скрипту необходимо передать один аргумент, например: ./make-config.sh client-1) 
- Описания работы систем мониторинга и бэкапирования можно найти в репозитории.
- Необходимые deb-пакеты с конфигурационными файлами опубликованы в релизах репозитория.


8. Резюме:
- Все серверы взаимодействуют через SSH для бэкапирования и через HTTP/HTTPS для сбора метрик.
- Prometheus централизованно собирает метрики и управляет уведомлениями через Alertmanager.
- Пользователи получают доступ к серверам через SSH (администрирование) и VPN (доступ к внутренним ресурсам).
- Веб-интерфейс Prometheus доступен по домену raif.hopto.org через HTTPS и защищён SSL-сертификатом, созданным с помощью certbot.
- Для автоматизации развёртывания используются скрипты и deb-пакеты из репозитория (https://github.com/RaifSpace/raif-devops).
- Все сервисы работают на стандартных портах.
